name: Medium CI (Tier 2)

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 12 * * *'  # Daily at noon UTC
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  LIBTORCH_USE_PYTORCH: 1

jobs:
  medium-tests:
    name: Integration & Hardware Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: medium-ci-${{ runner.os }}

    - name: Run all fast tests first
      run: |
        # Unit tests
        cargo test --lib \
          --no-default-features \
          --features quantization,pruning,distillation,hardware-targets

        # Essential integration tests
        cargo test \
          --test enhanced_simulation_test \
          --test benchmarking_basic_test \
          --test cli_test \
          --no-default-features \
          --features quantization,pruning,distillation,hardware-targets

    - name: Run hardware integration tests
      run: |
        cargo test \
          --test arduino_integration \
          --test stm32_integration \
          --test hardware_deployment_validation_test \
          --no-default-features \
          --features quantization,pruning,distillation,hardware-targets \
          --verbose

    - name: Run optimization tests
      run: |
        cargo test \
          --test advanced_quantization_test \
          --test pruning_integration_test \
          --test distillation_integration_test \
          --no-default-features \
          --features quantization,pruning,distillation,hardware-targets \
          --verbose

    - name: Run cross-format validation
      run: |
        cargo test \
          --test cross_format_validation_test \
          --test onnx_converter_test \
          --test pytorch_converter_test \
          --no-default-features \
          --features quantization,pruning,distillation,hardware-targets \
          --verbose

    - name: Run benchmarking suite
      run: |
        cargo test \
          --test benchmarking_suite_test \
          --no-default-features \
          --features quantization,pruning,distillation,hardware-targets \
          --verbose